# Azure Machine Learning Deployment Configuration
# For deploying the archive forecast model as an online endpoint or batch job
# 
# Usage:
#   1. Register model: python src/ml/register_model.py --model-path models/model.joblib --model-name archive-forecast --version 1.0.0
#   2. Create endpoint: az ml online-endpoint create -f deployment_config.yaml
#   3. Create deployment: az ml online-deployment create -f deployment_config.yaml --endpoint-name archive-forecast-ep
#
# Reference: https://learn.microsoft.com/en-us/azure/machine-learning/how-to-deploy-online-endpoints

# =========================
# ONLINE ENDPOINT DEPLOYMENT
# =========================

$schema: https://azuremlschemas.azureedge.net/latest/onlineDeployment.schema.json

# Deployment name and endpoint
name: archive-forecast-blue
endpoint_name: archive-forecast-ep
description: "Archive volume and storage savings forecast model - Blue deployment"

# Model reference
model: azureml:archive-forecast@latest

# Runtime environment
environment: azureml:archive-forecast-env@latest

# Scoring script
code_scoring_uri: ./src/ml

# Compute configuration
compute: Standard_F2s_v2
instance_count: 1

# Request settings
request_settings:
  request_timeout_ms: 60000          # 60 seconds timeout per request
  max_concurrent_requests_per_instance: 10
  max_queue_wait_ms: 500

# Probes for health checks
liveness_probe:
  initial_delay: 10
  period: 10
  timeout: 2
  success_threshold: 1
  failure_threshold: 30

readiness_probe:
  initial_delay: 10
  period: 10
  timeout: 2
  success_threshold: 1
  failure_threshold: 30

# Traffic allocation (for canary/shadow deployments)
traffic: 100

---

# =========================
# ENVIRONMENT DEFINITION
# =========================

$schema: https://azuremlschemas.azureedge.net/latest/environment.schema.json

name: archive-forecast-env
version: 1
description: "Environment for archive forecast model scoring"
image: mcr.microsoft.com/azureml/openmpi4.1.0-ubuntu22.04:latest
conda_file: environment.yml

---

# =========================
# ALTERNATIVE: BATCH INFERENCE
# =========================
# Use this configuration for batch prediction jobs

$schema: https://azuremlschemas.azureedge.net/latest/batchDeployment.schema.json

name: archive-forecast-batch
endpoint_name: archive-forecast-batch-ep
description: "Archive forecast batch inference deployment"

# Model reference
model: azureml:archive-forecast@latest

# Compute - use larger clusters for batch
compute: aml-compute-batch
instance_count: 4

# Input/output configuration
input_data: azureml:archive-forecast-data@latest
mini_batch_size: "100"
output_action: append_row
output_file_name: predictions.csv

# Error handling
max_retries: 3
timeout: 3600  # 1 hour per batch job

# Resource requests
resources:
  instance_type: Standard_D4s_v3
  instance_count: 4

environment_variables:
  MODEL_VERSION: "1.0.0"
  LOG_LEVEL: "INFO"

---

# =========================
# DEPLOYMENT CHECKLIST
# =========================
# Before deploying:
# 
# 1. ✅ Model registered in Azure ML: python src/ml/register_model.py --model-path models/model.joblib --model-name archive-forecast --version 1.0.0
# 2. ✅ Environment created: az ml environment create -f environment.yml
# 3. ✅ Test scoring locally: python src/ml/score.py
# 4. ✅ Endpoint configuration validated
# 5. ✅ Compute resources available
# 
# Deploy:
#   az ml online-endpoint create -f deployment_config.yaml
#   az ml online-deployment create -f deployment_config.yaml --endpoint-name archive-forecast-ep
#
# Test endpoint:
#   az ml online-endpoint invoke --name archive-forecast-ep --request-file test_request.json
#
# Update deployment (blue-green):
#   az ml online-deployment create -f deployment_config_green.yaml --endpoint-name archive-forecast-ep
#   az ml online-endpoint update --name archive-forecast-ep --traffic "archive-forecast-blue=50 archive-forecast-green=50"
#   az ml online-endpoint update --name archive-forecast-ep --traffic "archive-forecast-blue=0 archive-forecast-green=100"
#   az ml online-deployment delete --name archive-forecast-blue --endpoint-name archive-forecast-ep
